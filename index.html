<!-- index.html Â· WhoAI Evoï¼ˆ4è‰²å¯¾å¿œï¼špink/blue/green/purpleï¼‰ -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI Evo Â· Game</title>
<style>
  :root{ --fg:#fff; --glass:rgba(255,255,255,.12) }
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,sans-serif;color:var(--fg);
    background:#000 url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;gap:16px;padding:16px;
  }
  .container{width:min(820px,96vw);display:flex;flex-direction:column;gap:16px}
  .card{
    border:1px solid rgba(255,255,255,.18);border-radius:16px;
    background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.36));
    padding:20px;text-align:center
  }
  .hidden{display:none}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{
    flex:1 1 auto;min-width:120px;padding:12px 14px;font-size:16px;
    border-radius:999px;border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.35);color:#fff;cursor:pointer
  }
  button:active{transform:scale(.97)}
  input{
    padding:10px;font-size:16px;border-radius:8px;border:1px solid rgba(255,255,255,.3);
    width:80%;max-width:320px;background:rgba(0,0,0,.25);color:#fff
  }

  /* ç›¤é¢ */
  .hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:6px}
  .tag{padding:.25em .7em;border:1px solid rgba(255,255,255,.25);border-radius:999px;font-size:12px;background:rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:6px}
  .cell{
    aspect-ratio:1/1;border:1px solid rgba(255,255,255,.2);border-radius:12px;
    display:flex;align-items:center;justify-content:center;background:var(--glass);position:relative;overflow:hidden;
  }
  .label{position:absolute;left:6px;top:6px;font-size:12px;opacity:.75}
  .char{width:72%;max-width:120px;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.5));user-select:none;-webkit-user-drag:none}
  .goal{width:62%;max-width:110px;object-fit:contain;animation:bounce 1.2s infinite}
  .note{position:absolute;right:8px;bottom:6px;font-size:22px}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .log{border:1px solid rgba(255,255,255,.18);border-radius:12px;background:rgba(0,0,0,.25);padding:10px;min-height:64px;max-height:38vh;overflow:auto;font-size:14px;text-align:left}

  /* ä¸­å¤®æ¼”å‡ºï¼ˆãƒ‰ãƒªãƒ³ã‚¯/ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ï¼‰ */
  .center{
    display:flex;flex-direction:column;align-items:center;gap:10px;min-height:40vh;justify-content:center
  }
  .bigChar{width:min(55vw,320px);height:auto;filter:drop-shadow(0 8px 24px rgba(0,0,0,.55))}
</style>
</head>
<body>
<div class="container">

  <!-- 1) åå‰ -->
  <section id="view-name" class="card">
    <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«åå‰ã‚’ã¤ã‘ã‚ˆã†</h2>
    <input id="nameInput" type="text" placeholder="ã‚­ãƒ£ãƒ©ã®åå‰">
    <div class="buttons">
      <button id="btnSetName">OK</button>
      <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
    </div>
  </section>

  <!-- 2) ã‚²ãƒ¼ãƒ  -->
  <section id="view-game" class="card hidden">
    <div class="hud">
      <strong id="sceneTitle">Scene 1ï¼šæ—…ã®ã¯ã˜ã¾ã‚Š</strong>
      <div>
        <span id="posTag" class="tag">ä½ç½®: 1/5</span>
        <span id="dieTag" class="tag">ãƒ€ã‚¤ã‚¹: â€•</span>
        <span id="notesTag" class="tag">éŸ³ç¬¦: 0/3</span>
      </div>
    </div>
    <div id="board" class="row"></div>
    <div class="buttons">
      <button id="rollBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­</button>
      <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
    </div>
    <div id="log" class="log"></div>
  </section>

  <!-- 3) ãƒ‰ãƒªãƒ³ã‚¯ -->
  <section id="view-drink" class="card hidden">
    <div class="title">ãƒ‰ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒ </div>
    <div class="subtitle">ã²ã¨ãã¡é£²ã‚“ã§ã€ã‚‚ã†ä¸€æ­©ã€‚</div>
    <div class="center">
      <img id="drinkImg" src="public/assets/stage1/milk_potion.png" alt="drink" class="bigChar" />
      <div class="buttons">
        <button id="drinkBtn">ğŸ¥› ã®ã‚€</button>
        <button id="toFinal">ã¤ãã¸</button>
      </div>
    </div>
  </section>

  <!-- 4) ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ -->
  <section id="view-final" class="card hidden">
    <div class="title">Finale</div>
    <div class="center">
      <img src="public/assets/stage1/ako.png" alt="ako" class="bigChar" />
      <div class="buttons">
        <button id="playHB">ğŸµ ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚’é³´ã‚‰ã™</button>
        <button id="replay">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
        <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
      </div>
    </div>
  </section>

</div>

<script>
(() => {
  /* ===== ASSETSï¼ˆ4è‰²å¯¾å¿œãƒ»å¿…è¦ãªã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã¦ãã ã•ã„ï¼‰ ===== */
  const CHAR_START  = "public/assets/stage1/miwacchi_open.png"; // æœ€åˆã®ã‚­ãƒ£ãƒ©
  const CHAR_PINK   = "public/assets/stage1/pink_open.png";
  const CHAR_BLUE   = "public/assets/stage1/blue_open.png";
  const CHAR_GREEN  = "public/assets/stage1/green_open.png";
  const CHAR_PURPLE = "public/assets/stage1/purple_open.png";   // è¿½åŠ ï¼šãƒ‘ãƒ¼ãƒ—ãƒ«

  const MAC_PINK    = "public/assets/stage1/macaron_pink.png";
  const MAC_BLUE    = "public/assets/stage1/macaron_blue.png";
  const MAC_GREEN   = "public/assets/stage1/macaron_green.png";
  const MAC_PURPLE  = "public/assets/stage1/macaron_purple.png"; // è¿½åŠ ï¼šãƒ‘ãƒ¼ãƒ—ãƒ«
  /* ============================================================ */

  // ãƒ“ãƒ¥ãƒ¼
  const V = {
    name: document.getElementById('view-name'),
    game: document.getElementById('view-game'),
    drink: document.getElementById('view-drink'),
    final: document.getElementById('view-final'),
    posTag: document.getElementById('posTag'),
    dieTag: document.getElementById('dieTag'),
    notesTag: document.getElementById('notesTag'),
    board: document.getElementById('board'),
    log: document.getElementById('log'),
    sceneTitle: document.getElementById('sceneTitle'),
  };

  function show(which){
    V.name.classList.toggle('hidden', which!=='name');
    V.game.classList.toggle('hidden', which!=='game');
    V.drink.classList.toggle('hidden', which!=='drink');
    V.final.classList.toggle('hidden', which!=='final');
  }

  // åå‰
  let charName = localStorage.getItem("whoai_name") || "";
  document.getElementById('btnSetName').onclick = () => {
    const val = document.getElementById('nameInput').value.trim();
    if(!val) return;
    charName = val;
    localStorage.setItem("whoai_name", charName);
    resetGame();
    show('game');
  };

  // ç›¤é¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const N = 5;
  let pos=1, last=0, got=false, notesOwned=0;

  // éŸ³ç¬¦ã‚’3ã¤ã€2..4ã®ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®
  let notes = new Set();
  function rollNotes(){
    notes.clear();
    while(notes.size<3){
      const m = Math.floor(Math.random()* (N-2)) + 2; // 2..4
      notes.add(m);
    }
  }

  // ãƒã‚«ãƒ­ãƒ³ã®è‰² â†’ é€²åŒ–ã‚­ãƒ£ãƒ©ï¼ˆ4è‰²ï¼‰
  const COLORS = [
    {name:'pink',   mac:MAC_PINK,   evo:CHAR_PINK},
    {name:'blue',   mac:MAC_BLUE,   evo:CHAR_BLUE},
    {name:'green',  mac:MAC_GREEN,  evo:CHAR_GREEN},
    {name:'purple', mac:MAC_PURPLE, evo:CHAR_PURPLE}, // è¿½åŠ 
  ];
  let goal = COLORS[Math.floor(Math.random()*COLORS.length)];
  let evolvedChar = CHAR_PINK;

  function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }
  function log(s,cls){ const d=document.createElement('div'); if(cls)d.className=cls; d.textContent=(charName?charName+"ï¼š":"")+s; V.log.prepend(d); }

  function renderBoard(){
    V.posTag.textContent = `ä½ç½®: ${pos}/${N}`;
    V.dieTag.textContent = `ãƒ€ã‚¤ã‚¹: ${last||'â€•'}`;
    V.notesTag.textContent = `éŸ³ç¬¦: ${notesOwned}/3`;

    V.board.innerHTML = '';
    for(let i=1;i<=N;i++){
      const cell=document.createElement('div'); cell.className='cell';
      const label=document.createElement('span'); label.className='label'; label.textContent=i; cell.appendChild(label);

      // ã‚­ãƒ£ãƒ©ï¼ˆScene1ã¯åˆæœŸã‚­ãƒ£ãƒ©ï¼‰
      if(i===pos){
        const img=document.createElement('img'); img.src=CHAR_START; img.alt='char'; img.className='char'; cell.appendChild(img);
      }
      // ã‚´ãƒ¼ãƒ«ã®ãƒã‚«ãƒ­ãƒ³
      if(i===N){
        const g=document.createElement('img'); g.src=goal.mac; g.alt='macaron'; g.className='goal'; cell.appendChild(g);
      }
      // éŸ³ç¬¦
      if(notes.has(i)){
        const note=document.createElement('div'); note.className='note'; note.textContent='ğŸµ'; cell.appendChild(note);
      }
      V.board.appendChild(cell);
    }
  }

  function collectNoteIfAny(at){
    if(notes.has(at)){
      notes.delete(at);
      notesOwned++;
      log("ğŸµ éŸ³ç¬¦ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼");
    }
  }

  function roll(){
    if(got){ log("ã‚‚ã†ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ã­"); vibrate(20); return; }
    last = Math.floor(Math.random()*6)+1;
    const next = pos + last;

    if(next === N){
      pos = next;
      collectNoteIfAny(pos);
      log(`ğŸ² ${last} â†’ ã´ã£ãŸã‚Š${N}ï¼ ${goal.name} ãƒã‚«ãƒ­ãƒ³ï¼`, 'ok');
      vibrate(70);
      got = true;
      evolvedChar = goal.evo; // åˆ°é”è‰²ã«åˆã‚ã›ãŸé€²åŒ–
      setTimeout(()=>{ show('drink'); }, 400);
    }else if(next < N){
      pos = next;
      collectNoteIfAny(pos);
      log(`ğŸ² ${last} â†’ ä½ç½® ${pos}/${N}`);
      vibrate(20);
      renderBoard();
    }else{
      log(`ğŸ² ${last} â†’ ${next} é€šã‚Šéãï¼ˆç„¡åŠ¹ï¼‰`, 'ng');
      vibrate(10);
    }
    renderBoard();
  }

  function resetGame(){
    pos=1; last=0; got=false; notesOwned=0;
    goal = COLORS[Math.floor(Math.random()*COLORS.length)];
    rollNotes();
    V.log.innerHTML='';
    V.sceneTitle.textContent = "Scene 1ï¼šæ—…ã®ã¯ã˜ã¾ã‚Š";
    renderBoard();
  }

  document.getElementById('rollBtn').onclick = roll;
  document.getElementById('resetBtn').onclick = resetGame;

  // ãƒ‰ãƒªãƒ³ã‚¯
  document.getElementById('drinkBtn').onclick = () => {
    playToneSeq([{freq:784,dur:0.12},{freq:988,dur:0.12},{freq:1175,dur:0.18}]);
  };
  document.getElementById('toFinal').onclick = () => {
    show('final');
    try{ playHappyBirthday(); }catch(e){}
  };

  // ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬
  document.getElementById('playHB').onclick = () => { playHappyBirthday(); };
  document.getElementById('replay').onclick = () => {
    resetGame();
    show('game');
  };

  // åˆæœŸè¡¨ç¤º
  if(charName){ resetGame(); show('game'); } else { show('name'); }

  /* ===== ã‚µã‚¦ãƒ³ãƒ‰ï¼šWeb Audio ===== */
  let audioCtx;
  function ctx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
  function playToneSeq(seq){
    const ac = ctx();
    let t = ac.currentTime + 0.02;
    seq.forEach(s=>{
      const o=ac.createOscillator(), g=ac.createGain();
      o.type='sine'; o.frequency.value=s.freq;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.18, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, t+s.dur);
      o.connect(g).connect(ac.destination);
      o.start(t); o.stop(t+s.dur+0.02);
      t += s.dur + (s.gap||0.02);
    });
  }
  function playHappyBirthday(){
    const q = 0.30, e = 0.15;
    const d = (n)=>({freq:note(n), dur:e});
    const qn = (n)=>({freq:note(n), dur:q});
    const seq = [
      d('G4'), d('G4'), qn('A4'), qn('G4'), qn('C5'), qn('B4'),
      d('G4'), d('G4'), qn('A4'), qn('G4'), qn('D5'), qn('C5'),
      d('G4'), d('G4'), qn('G5'), qn('E5'), qn('C5'), qn('B4'), qn('A4'),
      d('F5'), d('F5'), qn('E5'), qn('C5'), qn('D5'), qn('C5')
    ];
    playToneSeq(seq);
  }
  function note(n){
    const N = {
      'C4':261.63,'C#4':277.18,'D4':293.66,'D#4':311.13,'E4':329.63,'F4':349.23,'F#4':369.99,'G4':392.00,'G#4':415.30,'A4':440.00,'A#4':466.16,'B4':493.88,
      'C5':523.25,'C#5':554.37,'D5':587.33,'D#5':622.25,'E5':659.25,'F5':698.46,'F#5':739.99,'G5':783.99,'G#5':830.61,'A5':880.00,'A#5':932.33,'B5':987.77
    };
    return N[n]||440;
  }
})();
</script>
</body>
</html>
