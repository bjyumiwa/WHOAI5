<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI Evo Â· Game</title>
<style>
  :root{
    --fg:#fff; --glass:rgba(255,255,255,.10); --glow:rgba(173,216,255,.45);
    --pink:#ffc7de; --blue:#bfe3ff; --green:#c9f3d2; --purple:#e0c9ff;
  }
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Arial,sans-serif;color:var(--fg);
    background:#000 url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;gap:18px;padding:18px;
  }
  .container{width:min(980px,96vw);display:flex;flex-direction:column;gap:16px}
  .card{
    border-radius:20px;
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));
    box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.12);
    backdrop-filter:blur(6px);
    padding:20px;text-align:center
  }
  .buttons{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{
    flex:1 1 auto;min-width:140px;padding:12px 16px;font-size:16px;border:none;border-radius:999px;
    color:#24313a;background:linear-gradient(180deg,#fff,#f2f6ff);box-shadow:0 6px 14px rgba(0,0,0,.25);
    outline:2px solid transparent;outline-offset:2px;cursor:pointer;
  }
  button:active{transform:translateY(1px)} button:focus-visible{outline-color:var(--glow)}
  a button{color:#24313a}

  /* ç›¤é¢ */
  .hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tag{padding:.35em .75em;border-radius:999px;font-size:12px;background:rgba(255,255,255,.18);box-shadow:inset 0 0 0 1px rgba(255,255,255,.16)}
  .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:6px}
  .cell{
    aspect-ratio:1/1;border-radius:18px;position:relative;overflow:hidden;
    background:
      radial-gradient(120% 80% at 20% 20%, rgba(255,255,255,.22), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.12), inset 0 -10px 20px rgba(0,0,0,.18), 0 6px 18px rgba(0,0,0,.35);
    display:flex;align-items:center;justify-content:center;
  }
  .label{
    position:absolute;left:8px;top:8px;font-size:13px;font-weight:700;color:#24313a;
    background:#fff;border-radius:999px;padding:.25em .55em;box-shadow:0 2px 6px rgba(0,0,0,.25)
  }
  .char{width:72%;max-width:120px;object-fit:contain;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}
  .goal{width:62%;max-width:110px;object-fit:contain;animation:bounce 1.2s ease-in-out infinite}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .note{position:absolute;right:8px;bottom:6px;font-size:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
  .log{background:rgba(255,255,255,.08);border-radius:14px;padding:10px;min-height:64px;max-height:28vh;overflow:auto;font-size:14px;text-align:left;box-shadow:inset 0 0 0 1px rgba(255,255,255,.12)}

  /* ä¸‹éƒ¨ãƒ‘ãƒãƒ« */
  .panel{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .stat{border-radius:16px;background:rgba(255,255,255,.08);padding:12px;text-align:left;box-shadow:inset 0 0 0 1px rgba(255,255,255,.12)}
  .stat h3{margin:0 0 8px 0;font-size:16px}
  .grid2{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .pill{border-radius:999px;padding:.45em .7em;text-align:center;background:#fff;color:#24313a;box-shadow:0 3px 10px rgba(0,0,0,.2)}
  .diceTable{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:14px}
  .diceTable th,.diceTable td{background:rgba(255,255,255,.12);padding:8px 10px;text-align:center;backdrop-filter:blur(4px)}
  .diceTable th:first-child,.diceTable td:first-child{border-radius:999px 0 0 999px}
  .diceTable th:last-child,.diceTable td:last-child{border-radius:0 999px 999px 0}
  .diceFaces{font-size:20px;letter-spacing:2px}
  .small{opacity:.9;font-size:12px}

  /* ãƒ‰ãƒªãƒ³ã‚¯/ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ */
  .center{display:flex;flex-direction:column;align-items:center;gap:10px;min-height:40vh;justify-content:center}
  .bigChar{width:min(55vw,320px);height:auto;filter:drop-shadow(0 8px 24px rgba(0,0,0,.55))}
  .hidden{display:none}

  /* akoï¼šæš«å®šâ€œç™½æŠœãå¯¾ç­–â€ */
  .ako{animation:sway 3s ease-in-out infinite; mix-blend-mode:multiply;}
  @keyframes sway{0%{transform:rotate(-2deg)}50%{transform:rotate(2deg) translateY(-3px)}100%{transform:rotate(-2deg)}}
</style>
</head>
<body>
<div class="container">

  <!-- 0) Coverï¼ˆæ–°è¦ï¼‰ -->
  <section id="view-cover" class="card">
    <img src="public/assets/stage1/miwacchi_open.png" alt="cover-char" style="width:140px;height:auto;filter:drop-shadow(0 6px 18px rgba(0,0,0,.55));margin-top:6px">
    <h1 style="margin:.2em 0 0 0">WhoAI Evo</h1>
    <div style="opacity:.9;margin:.2em 0 1em 0">å¶ç„¶ã¨æ„æ€ã®ã¯ã–ã¾ã§è‚²ã¤ã€å°ã•ãªé€²åŒ–ã®ç‰©èªã€‚</div>
    <div class="buttons">
      <button id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
    </div>
  </section>

  <!-- 1) åå‰ -->
  <section id="view-name" class="card hidden">
    <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«åå‰ã‚’ã¤ã‘ã‚ˆã†</h2>
    <input id="nameInput" type="text" placeholder="ã‚­ãƒ£ãƒ©ã®åå‰" inputmode="latin-name">
    <div class="buttons">
      <button id="btnSetName">OK</button>
      <button id="btnBackCover">è¡¨ç´™ã¸</button>
    </div>
  </section>

  <!-- 2) ã‚²ãƒ¼ãƒ  -->
  <section id="view-game" class="card hidden">
    <h1 style="margin-top:2px">WhoAI Evo ğŸ²</h1>
    <p id="greet" style="margin-top:0"></p>

    <div class="hud">
      <strong id="sceneTitle">Scene 1ï¼šæ—…ã®ã¯ã˜ã¾ã‚Š</strong>
      <div>
        <span id="posTag" class="tag">ä½ç½®: 1/5</span>
        <span id="dieTag" class="tag">ãƒ€ã‚¤ã‚¹: â€•</span>
        <span id="notesTag" class="tag">éŸ³ç¬¦: 0/3</span>
      </div>
    </div>

    <div id="board" class="row"></div>

    <div class="buttons">
      <button id="rollBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­</button>
      <button id="softResetBtn">ğŸ”„ ä½ç½®ã ã‘åˆæœŸåŒ–</button>
      <button id="renameBtn">ğŸ“ åå‰ã‚’å¤‰ãˆã‚‹</button>
      <button id="toStartBtn">â® ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</button>
      <button id="hardResetBtn">ğŸ§¹ å…¨åˆæœŸåŒ–ï¼ˆåå‰ã¨è¨˜éŒ²ã‚‚ï¼‰</button>
      <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
    </div>

    <div id="log" class="log"></div>

    <div class="panel">
      <div class="stat">
        <h3>ã‚²ãƒƒãƒˆè¡¨ï¼šãƒã‚«ãƒ­ãƒ³ï¼ˆç´¯ç©ï¼‰</h3>
        <div class="grid2">
          <div class="pill" id="macPink">ãƒ”ãƒ³ã‚¯ 0</div>
          <div class="pill" id="macBlue">ãƒ–ãƒ«ãƒ¼ 0</div>
          <div class="pill" id="macGreen">ã‚°ãƒªãƒ¼ãƒ³ 0</div>
          <div class="pill" id="macPurple">ãƒ‘ãƒ¼ãƒ—ãƒ« 0</div>
        </div>
        <h3 style="margin-top:12px">ã‚²ãƒƒãƒˆè¡¨ï¼šéŸ³ç¬¦ï¼ˆç´¯ç© / ä»Šå›ï¼‰</h3>
        <div class="grid2">
          <div class="pill" id="noteAll">ç´¯ç© 0</div>
          <div class="pill" id="noteRun">ä»Šå› 0/3</div>
          <div class="pill" id="runs">ãƒ—ãƒ¬ã‚¤å›æ•° 0</div>
          <div class="pill"><a href="?new=1" style="color:#24313a;text-decoration:none">?new=1 ã§åå‰ã‹ã‚‰</a></div>
        </div>
      </div>

      <div class="stat">
        <h3>ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®</h3>
        <table class="diceTable">
          <tr><th>é¢</th><th>âš€</th><th>âš</th><th>âš‚</th><th>âšƒ</th><th>âš„</th><th>âš…</th></tr>
          <tr>
            <td>ç´¯ç©</td>
            <td id="d1">0</td><td id="d2">0</td><td id="d3">0</td>
            <td id="d4">0</td><td id="d5">0</td><td id="d6">0</td>
          </tr>
        </table>
        <div style="margin-top:8px">
          <div class="small">ç›´è¿‘ï¼ˆæœ€å¤§10å›ï¼‰</div>
          <div id="diceHistory" class="diceFaces">â€”</div>
        </div>
      </div>
    </div>
  </section>

  <!-- 3) ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãƒ‘ãƒ¼ãƒ—ãƒ«é€²åŒ–ã®å¾Œã ã‘æ¥ã‚‹ï¼‰ -->
  <section id="view-drink" class="card hidden">
    <div class="title">ãƒ‰ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒ </div>
    <div class="subtitle">ã²ã¨ãã¡é£²ã‚“ã§ã€ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ã¸ã€‚</div>
    <div class="center">
      <img id="drinkImg" src="public/assets/stage1/drink_item.png" alt="drink" class="bigChar" />
      <div class="buttons">
        <button id="drinkBtn">ğŸ¥› ã®ã‚€</button>
        <button id="toFinal">ã¤ãã¸</button>
      </div>
    </div>
  </section>

  <!-- 4) ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ -->
  <section id="view-final" class="card hidden">
    <div class="title">Finale</div>
    <div class="center">
      <!-- é€æ˜PNGãŒæœ€é©ï¼æš«å®šã¯ mix-blend-mode ã§ç™½åœ°ã‚’ãªã˜ã¾ã›ã‚‹ -->
      <img src="public/assets/stage1/ako.png" alt="ako" class="bigChar ako" />
      <div class="buttons">
        <button id="playHB">ğŸµ ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚’é³´ã‚‰ã™</button>
        <button id="replay">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
        <a href="about.html"><button>ğŸ“– ç ”ç©¶ã®èª¬æ˜</button></a>
      </div>
    </div>
  </section>

</div>

<script>
(() => {
  /* ===== ASSETS ===== */
  const CHAR_START  = "public/assets/stage1/miwacchi_open.png";
  const CHAR_PINK   = "public/assets/stage1/pink_open.png";
  const CHAR_BLUE   = "public/assets/stage1/blue_open.png";
  const CHAR_GREEN  = "public/assets/stage1/green_open.png";
  const CHAR_PURPLE = "public/assets/stage1/purple_open.png";
  const MAC_PINK    = "public/assets/stage1/macaron_pink.png";
  const MAC_BLUE    = "public/assets/stage1/macaron_blue.png";
  const MAC_GREEN   = "public/assets/stage1/macaron_green.png";
  const MAC_PURPLE  = "public/assets/stage1/macaron_purple.png";

  const V = {
    cover:document.getElementById('view-cover'),
    name: document.getElementById('view-name'),
    game: document.getElementById('view-game'),
    drink:document.getElementById('view-drink'),
    final:document.getElementById('view-final'),
    greet:document.getElementById('greet'),
    posTag:document.getElementById('posTag'),
    dieTag:document.getElementById('dieTag'),
    notesTag:document.getElementById('notesTag'),
    board:document.getElementById('board'),
    log:document.getElementById('log'),
    sceneTitle:document.getElementById('sceneTitle'),
    macPink:document.getElementById('macPink'),
    macBlue:document.getElementById('macBlue'),
    macGreen:document.getElementById('macGreen'),
    macPurple:document.getElementById('macPurple'),
    noteAll:document.getElementById('noteAll'),
    noteRun:document.getElementById('noteRun'),
    runs:document.getElementById('runs'),
    dCells:[null,document.getElementById('d1'),document.getElementById('d2'),document.getElementById('d3'),document.getElementById('d4'),document.getElementById('d5'),document.getElementById('d6')],
    diceHistory:document.getElementById('diceHistory')
  };
  function show(which){
    V.cover.classList.toggle('hidden', which!=='cover');
    V.name.classList.toggle('hidden', which!=='name');
    V.game.classList.toggle('hidden', which!=='game');
    V.drink.classList.toggle('hidden', which!=='drink');
    V.final.classList.toggle('hidden', which!=='final');
  }

  // Cover â†’ åå‰
  document.getElementById('btnStart').onclick = () => show('name');
  document.getElementById('btnBackCover').onclick = () => show('cover');

  // åå‰
  let charName = localStorage.getItem("whoai_name") || "";
  document.getElementById('btnSetName').onclick = () => {
    const val = document.getElementById('nameInput').value.trim();
    if(!val) return;
    charName = val;
    localStorage.setItem("whoai_name", charName);
    V.greet.textContent = `${charName} ã®å†’é™ºãŒå§‹ã¾ã‚‹ã‚ˆï¼`;
    resetGame(true);
    show('game');
  };

  // ç´¯ç©çµ±è¨ˆ
  const defaultStats = {macarons:{pink:0,blue:0,green:0,purple:0}, notes:0, runs:0, dice:[0,0,0,0,0,0]};
  const readStats = ()=>{ try{ return JSON.parse(localStorage.getItem('whoai_stats')) || structuredClone(defaultStats);}catch(e){return structuredClone(defaultStats);} };
  const writeStats = (s)=>localStorage.setItem('whoai_stats', JSON.stringify(s));
  let stats = readStats();

  // å‡ºç›®
  const faces = ["âš€","âš","âš‚","âšƒ","âš„","âš…"];
  let recentFaces = [];
  function renderDicePanel(){ for(let i=1;i<=6;i++) V.dCells[i].textContent = stats.dice[i-1]; V.diceHistory.textContent = recentFaces.length?recentFaces.join(" "):"â€”"; }
  function pushRecent(f){ recentFaces.unshift(f); if(recentFaces.length>10) recentFaces.pop(); renderDicePanel(); }

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  const N=5;
  let pos=1,last=0,got=false,notesOwned=0;
  let currentChar = CHAR_START;          // â† ã„ã¾ã®å§¿
  const COLORS = [
    {key:'pink',   mac:MAC_PINK,   evo:CHAR_PINK},
    {key:'blue',   mac:MAC_BLUE,   evo:CHAR_BLUE},
    {key:'green',  mac:MAC_GREEN,  evo:CHAR_GREEN},
    {key:'purple', mac:MAC_PURPLE, evo:CHAR_PURPLE},
  ];
  let collected = new Set();             // å–ã£ãŸè‰²
  let goal = pickNextGoal();             // æœ€åˆã®ã‚´ãƒ¼ãƒ«

  // éŸ³ç¬¦é…ç½®
  let notes = new Set();
  function rollNotes(){ notes.clear(); while(notes.size<3){ const m=Math.floor(Math.random()*(N-2))+2; notes.add(m);} }

  function pickNextGoal(){
    const remain = COLORS.filter(c=>!collected.has(c.key));
    const pick = remain[Math.floor(Math.random()*remain.length)];
    return pick;
  }

  function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }
  function log(s,cls){ const d=document.createElement('div'); if(cls)d.className=cls; d.textContent=(charName?charName+"ï¼š":"")+s; V.log.prepend(d); }

  function labelTint(i){ return [ 'var(--pink)','var(--blue)','var(--green)','var(--purple)','var(--pink)'][ (i-1)%4 ]; }

  function renderStats(){
    V.macPink.textContent   = `ãƒ”ãƒ³ã‚¯ ${stats.macarons.pink}`;
    V.macBlue.textContent   = `ãƒ–ãƒ«ãƒ¼ ${stats.macarons.blue}`;
    V.macGreen.textContent  = `ã‚°ãƒªãƒ¼ãƒ³ ${stats.macarons.green}`;
    V.macPurple.textContent = `ãƒ‘ãƒ¼ãƒ—ãƒ« ${stats.macarons.purple}`;
    V.noteAll.textContent   = `ç´¯ç© ${stats.notes}`;
    V.runs.textContent      = `ãƒ—ãƒ¬ã‚¤å›æ•° ${stats.runs}`;
    V.noteRun.textContent   = `ä»Šå› ${notesOwned}/3`;
  }

  function renderBoard(){
    V.posTag.textContent = `ä½ç½®: ${pos}/${N}`;
    V.dieTag.textContent = `ãƒ€ã‚¤ã‚¹: ${last?faces[last-1]:'â€•'}`;
    V.notesTag.textContent = `éŸ³ç¬¦: ${notesOwned}/3`;
    renderStats(); renderDicePanel();

    V.board.innerHTML='';
    for(let i=1;i<=N;i++){
      const cell=document.createElement('div'); cell.className='cell';
      const label=document.createElement('span'); label.className='label'; label.textContent=i; label.style.background = labelTint(i); cell.appendChild(label);
      if(i===pos){ const img=document.createElement('img'); img.src=currentChar; img.className='char'; cell.appendChild(img); }
      if(i===N){ const g=document.createElement('img'); g.src=goal.mac; g.className='goal'; cell.appendChild(g); }
      if(notes.has(i)){ const note=document.createElement('div'); note.className='note'; note.textContent='ğŸµ'; cell.appendChild(note); }
      V.board.appendChild(cell);
    }
  }

  function collectNoteIfAny(at){ if(notes.has(at)){ notes.delete(at); notesOwned++; log("ğŸµ éŸ³ç¬¦ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼"); renderStats(); } }

  function roll(){
    if(got){ log("ã‚‚ã†ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã€‚ä½ç½®ã ã‘åˆæœŸåŒ–ã—ã¦ã­"); vibrate(20); return; }
    last = Math.floor(Math.random()*6)+1;
    const face = faces[last-1]; stats.dice[last-1]++; writeStats(stats); pushRecent(face);
    const next = pos + last;

    if(next === N){
      pos = next; collectNoteIfAny(pos);
      // é€²åŒ–
      currentChar = goal.evo; collected.add(goal.key);
      log(`${face} â†’ ã´ã£ãŸã‚Š${N}ï¼ ${goal.key} ã«é€²åŒ–ï¼`, 'ok'); vibrate(70);
      stats.macarons[goal.key] += 1; stats.notes += notesOwned; writeStats(stats); renderStats();

      if(goal.key === 'purple'){  // ãƒ‘ãƒ¼ãƒ—ãƒ«ã§ãƒ‰ãƒªãƒ³ã‚¯ã¸
        got = true;
        setTimeout(()=>show('drink'), 420);
      }else{
        // ç¶šè¡Œï¼šæ¬¡ã®ã‚´ãƒ¼ãƒ«ã‚’æœªå–å¾—è‰²ã‹ã‚‰é¸ã¶
        pos=1; last=0; notesOwned=0; V.log.innerHTML='';
        goal = pickNextGoal(); rollNotes(); renderBoard();
        V.sceneTitle.textContent = "Scene ã¤ã¥ãï¼šã‚‚ã£ã¨é€²åŒ–ã—ã‚ˆã†";
      }

    }else if(next < N){
      pos = next; collectNoteIfAny(pos);
      log(`${face} â†’ ä½ç½® ${pos}/${N}`); vibrate(18); renderBoard();
    }else{
      log(`${face} â†’ ${next} é€šã‚Šéãï¼ˆç„¡åŠ¹ï¼‰`, 'ng'); vibrate(10);
    }
  }

  function softReset(){ pos=1; last=0; got=false; notesOwned=0; V.log.innerHTML=''; V.sceneTitle.textContent="Scene 1ï¼šæ—…ã®ã¯ã˜ã¾ã‚Š"; rollNotes(); renderBoard(); }
  function hardReset(){ localStorage.removeItem('whoai_name'); localStorage.removeItem('whoai_stats'); stats=readStats(); charName=""; V.greet.textContent=""; recentFaces=[]; currentChar=CHAR_START; collected.clear(); goal=pickNextGoal(); softReset(); show('cover'); }
  function toStart(){ document.getElementById('nameInput').value = localStorage.getItem('whoai_name') || ''; show('name'); }
  function resetGame(incrementRun){ collected.clear(); currentChar=CHAR_START; goal=pickNextGoal(); softReset(); if(incrementRun){ stats.runs++; writeStats(stats); renderStats(); } }

  document.getElementById('rollBtn').onclick=roll;
  document.getElementById('softResetBtn').onclick=softReset;
  document.getElementById('hardResetBtn').onclick=hardReset;
  document.getElementById('renameBtn').onclick=toStart;
  document.getElementById('toStartBtn').onclick=()=>show('cover');

  // ãƒ‰ãƒªãƒ³ã‚¯ â†’ ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬
  document.getElementById('drinkBtn').onclick = () => playToneSeq([{freq:784,dur:0.12},{freq:988,dur:0.12},{freq:1175,dur:0.18}]);
  document.getElementById('toFinal').onclick = () => { show('final'); try{ playHappyBirthday(); }catch(e){} };
  document.getElementById('playHB').onclick = () => playHappyBirthday();
  document.getElementById('replay').onclick = () => { resetGame(false); show('game'); };

  // åˆæœŸè¡¨ç¤ºï¼šè¡¨ç´™
  show('cover');

  /* ===== éŸ³ ===== */
  let audioCtx; function ctx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
  function playToneSeq(seq){
    const ac=ctx(); let t=ac.currentTime+0.02;
    seq.forEach(s=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=s.freq;
      g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.18,t+0.02); g.gain.exponentialRampToValueAtTime(0.001,t+s.dur);
      o.connect(g).connect(ac.destination); o.start(t); o.stop(t+s.dur+0.02); t+=s.dur+(s.gap||0.02); });
  }
  function playHappyBirthday(){
    const q=.30,e=.15, d=n=>({freq:note(n),dur:e}), qn=n=>({freq:note(n),dur:q});
    const seq=[d('G4'),d('G4'),qn('A4'),qn('G4'),qn('C5'),qn('B4'),
               d('G4'),d('G4'),qn('A4'),qn('G4'),qn('D5'),qn('C5'),
               d('G4'),d('G4'),qn('G5'),qn('E5'),qn('C5'),qn('B4'),qn('A4'),
               d('F5'),d('F5'),qn('E5'),qn('C5'),qn('D5'),qn('C5')];
    playToneSeq(seq);
  }
  function note(n){
    const N={'C4':261.63,'C#4':277.18,'D4':293.66,'D#4':311.13,'E4':329.63,'F4':349.23,'F#4':369.99,'G4':392.00,'G#4':415.30,'A4':440.00,'A#4':466.16,'B4':493.88,
             'C5':523.25,'C#5':554.37,'D5':587.33,'D#5':622.25,'E5':659.25,'F5':698.46,'F#5':739.99,'G5':783.99,'G#5':830.61,'A5':880.00,'A#5':932.33,'B5':987.77};
    return N[n]||440;
  }

  // èµ·å‹•æ™‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  (function init(){ rollNotes(); renderBoard(); })();
})();
</script>
</body>
</html>
